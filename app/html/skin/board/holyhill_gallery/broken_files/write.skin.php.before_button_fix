<?php
if (!defined('_GNUBOARD_')) exit;

// ìˆ˜ì • ëª¨ë“œì¸ì§€ í™•ì¸
$is_edit = ($w == 'u') ? true : false;

// ê¸°ì¡´ ì´ë¯¸ì§€ (ìˆ˜ì • ì‹œ)
$existing_images = array();
if ($is_edit) {
    $file_result = sql_query("SELECT bf_file, bf_no FROM {$g5['board_file_table']} WHERE bo_table = '{$bo_table}' AND wr_id = '{$wr_id}' AND bf_type BETWEEN 1 AND 3 ORDER BY bf_no");
    while ($file = sql_fetch_array($file_result)) {
        $existing_images[] = array(
            'file' => $file['bf_file'],
            'no' => $file['bf_no'],
            'url' => G5_DATA_URL.'/file/'.$bo_table.'/'.$file['bf_file']
        );
    }
}
?>
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title><?php echo $is_edit ? 'ê²Œì‹œê¸€ ìˆ˜ì •' : 'ìƒˆ ê²Œì‹œê¸€'; ?></title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif; }
.preview-image {
    position: relative;
    width: 100%;
    padding-bottom: 100%;
    background: #f3f4f6;
    overflow: hidden;
}
.preview-image img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(0,0,0,0.7);
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
}
</style>
</head>
<body class="bg-gray-50">

<div class="max-w-2xl mx-auto bg-white min-h-screen">
    
    <!-- í—¤ë” -->
    <header class="fixed top-0 left-0 right-0 bg-white border-b z-50" style="max-width: 640px; margin: 0 auto;">
        <div class="flex items-center justify-between px-4 py-3">
            <button type="button" onclick="confirmExit()" class="text-gray-700">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
            <h1 class="text-lg font-semibold text-gray-800">
                <?php echo $is_edit ? 'ê²Œì‹œê¸€ ìˆ˜ì •' : 'ìƒˆ ê²Œì‹œê¸€'; ?>
            </h1>
            <button type="submit" form="writeForm" class="text-purple-600 font-semibold" id="submitBtn">
                <?php echo $is_edit ? 'ìˆ˜ì •' : 'ê³µìœ '; ?>
            </button>
        </div>
    </header>

    <!-- ë³¸ë¬¸ -->
    <main class="pt-16 pb-8">
        <form id="writeForm" name="fwrite" method="post" enctype="multipart/form-data" action="<?php echo G5_BBS_URL; ?>/write_update.php">
        <input type="hidden" name="w" value="<?php echo $w; ?>">
        <input type="hidden" name="bo_table" value="<?php echo $bo_table; ?>">
        <input type="hidden" name="wr_id" value="<?php echo $wr_id; ?>">
        <input type="hidden" name="sca" value="<?php echo $sca; ?>">
        <input type="hidden" name="sfl" value="<?php echo $sfl; ?>">
        <input type="hidden" name="stx" value="<?php echo $stx; ?>">
        <input type="hidden" name="spt" value="<?php echo $spt; ?>">
        <input type="hidden" name="sst" value="<?php echo $sst; ?>">
        <input type="hidden" name="sod" value="<?php echo $sod; ?>">
        <input type="hidden" name="page" value="<?php echo $page; ?>">
        
        <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„¹ì…˜ -->
        <div class="p-4 border-b">
            <label class="block mb-3">
                <span class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-image text-purple-600"></i>
                    ì‚¬ì§„ ì¶”ê°€ (ìµœëŒ€ 5ì¥)
                </span>
            </label>
            
            <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼ -->
            <div class="grid grid-cols-3 gap-2 mb-4" id="imagePreviewGrid">
                <label for="imageInput" class="preview-image border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-purple-400 transition-colors">
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                        <i class="fa-solid fa-plus text-3xl mb-2"></i>
                        <span class="text-xs">ì‚¬ì§„ ì¶”ê°€</span>
                    </div>
                </label>
            </div>
            
            <input type="file" id="imageInput" name="bf_file[]" accept="image/*" multiple style="display: none;" onchange="handleImageSelect(event)">
            
            <?php if ($is_edit && count($existing_images) > 0) { ?>
            <!-- ê¸°ì¡´ ì´ë¯¸ì§€ í‘œì‹œ -->
            <input type="hidden" name="bf_file_del[]" id="deleteList" value="">
            <div class="text-xs text-gray-500 mb-2">ê¸°ì¡´ ì´ë¯¸ì§€</div>
            <div class="grid grid-cols-3 gap-2 mb-4" id="existingImages">
                <?php foreach ($existing_images as $img) { ?>
                <div class="preview-image" data-file-no="<?php echo $img['no']; ?>">
                    <img src="<?php echo $img['url']; ?>" alt="">
                    <div class="delete-btn" onclick="deleteExistingImage(<?php echo $img['no']; ?>, this)">
                        <i class="fa-solid fa-xmark text-sm"></i>
                    </div>
                </div>
                <?php } ?>
            </div>
            <?php } ?>
            
            <p class="text-xs text-gray-500 mt-2">
                <i class="fa-solid fa-info-circle mr-1"></i>
                JPG, PNG, WebP í˜•ì‹ / íŒŒì¼ë‹¹ ìµœëŒ€ 5MB
            </p>
        </div>

        <!-- ì œëª© ì…ë ¥ -->
        <div class="p-4 border-b">
            <label class="block">
                <span class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-heading text-purple-600"></i>
                    ì œëª©
                </span>
                <input 
                    type="text" 
                    name="wr_subject" 
                    id="subjectInput"
                    value="<?php echo $is_edit ? get_text($write['wr_subject']) : ''; ?>"
                    placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    required
                    maxlength="200">
            </label>
        </div>

        <!-- ë‚´ìš© ì…ë ¥ -->
        <div class="p-4">
            <label class="block">
                <span class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-align-left text-purple-600"></i>
                    ë‚´ìš©
                </span>
                <textarea 
                    name="wr_content" 
                    id="contentInput"
                    placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”&#10;&#10;ì—¬ëŸ¬ë¶„ì˜ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ ì£¼ì„¸ìš” âœ¨"
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                    rows="10"
                    required><?php echo $is_edit ? get_text($write['wr_content']) : ''; ?></textarea>
            </label>
            
            <div class="flex items-center justify-between mt-3">
                <button type="button" onclick="insertEmoji()" class="text-gray-500 hover:text-purple-600 transition-colors">
                    <i class="fa-regular fa-face-smile text-xl"></i>
                </button>
                <span id="charCount" class="text-xs text-gray-500">0 / 3,000ì</span>
            </div>
        </div>

        <!-- ì¶”ê°€ ì˜µì…˜ (ê´€ë¦¬ì) -->
        <?php if ($is_admin) { ?>
        <div class="p-4 border-t bg-gray-50">
            <details class="group">
                <summary class="cursor-pointer text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-gear text-gray-500"></i>
                    ê´€ë¦¬ì ì˜µì…˜
                    <i class="fa-solid fa-chevron-down text-xs group-open:rotate-180 transition-transform ml-auto"></i>
                </summary>
                <div class="mt-3 space-y-3">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" name="notice" value="1" <?php echo $is_edit && $write['wr_is_comment'] == 0 ? 'checked' : ''; ?> class="rounded">
                        <span class="text-sm text-gray-700">ê³µì§€ì‚¬í•­ìœ¼ë¡œ ë“±ë¡</span>
                    </label>
                </div>
            </details>
        </div>
        <?php } ?>

        </form>
    </main>

</div>

<script>
let selectedFiles = [];
const maxFiles = 5;

// ì´ë¯¸ì§€ ì„ íƒ ì²˜ë¦¬
function handleImageSelect(event) {
    const files = Array.from(event.target.files);
    const grid = document.getElementById('imagePreviewGrid');
    const addButton = grid.querySelector('label[for="imageInput"]');
    
    // í˜„ì¬ ë¯¸ë¦¬ë³´ê¸° ê°œìˆ˜
    const currentPreviews = grid.querySelectorAll('.preview-image:not(label)').length;
    
    // ìµœëŒ€ ê°œìˆ˜ ì²´í¬
    if (currentPreviews + files.length > maxFiles) {
        alert(`ìµœëŒ€ ${maxFiles}ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
        event.target.value = '';
        return;
    }
    
    // íŒŒì¼ í¬ê¸° ë° í˜•ì‹ ì²´í¬
    for (let file of files) {
        if (file.size > 5 * 1024 * 1024) {
            alert('íŒŒì¼ í¬ê¸°ëŠ” 5MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + file.name);
            event.target.value = '';
            return;
        }
        
        if (!file.type.match('image.*')) {
            alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            event.target.value = '';
            return;
        }
    }
    
    // ë¯¸ë¦¬ë³´ê¸° ìƒì„±
    files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewDiv = document.createElement('div');
            previewDiv.className = 'preview-image';
            previewDiv.innerHTML = `
                <img src="${e.target.result}" alt="">
                <div class="delete-btn" onclick="removePreview(this)">
                    <i class="fa-solid fa-xmark text-sm"></i>
                </div>
            `;
            
            // + ë²„íŠ¼ ì•ì— ì¶”ê°€
            grid.insertBefore(previewDiv, addButton);
        };
        reader.readAsDataURL(file);
    });
    
    // + ë²„íŠ¼ ìˆ¨ê¹€/í‘œì‹œ
    if (currentPreviews + files.length >= maxFiles) {
        addButton.style.display = 'none';
    }
}

// ë¯¸ë¦¬ë³´ê¸° ì‚­ì œ
function removePreview(btn) {
    const preview = btn.parentElement;
    const grid = document.getElementById('imagePreviewGrid');
    const addButton = grid.querySelector('label[for="imageInput"]');
    
    preview.remove();
    
    // + ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
    addButton.style.display = 'block';
    
    // input íŒŒì¼ ë¦¬ì…‹
    document.getElementById('imageInput').value = '';
}

// ê¸°ì¡´ ì´ë¯¸ì§€ ì‚­ì œ
function deleteExistingImage(fileNo, btn) {
    if (!confirm('ì´ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    const preview = btn.parentElement;
    preview.remove();
    
    // ì‚­ì œí•  íŒŒì¼ ë²ˆí˜¸ ì¶”ê°€
    const deleteList = document.getElementById('deleteList');
    const currentList = deleteList.value ? deleteList.value.split(',') : [];
    currentList.push(fileNo);
    deleteList.value = currentList.join(',');
}

// ì´ëª¨ì§€ ì‚½ì…
function insertEmoji() {
    const emojis = ['ğŸ˜Š', 'â¤ï¸', 'ğŸ™', 'âœ¨', 'ğŸ‰', 'ğŸ‘', 'ğŸ’ª', 'ğŸŒŸ', 'ğŸ’•', 'ğŸ”¥'];
    const emoji = emojis[Math.floor(Math.random() * emojis.length)];
    const textarea = document.getElementById('contentInput');
    const pos = textarea.selectionStart;
    const text = textarea.value;
    textarea.value = text.slice(0, pos) + emoji + text.slice(pos);
    textarea.focus();
    textarea.setSelectionRange(pos + emoji.length, pos + emoji.length);
    updateCharCount();
}

// ê¸€ì ìˆ˜ ì¹´ìš´íŠ¸
function updateCharCount() {
    const content = document.getElementById('contentInput').value;
    const count = content.length;
    document.getElementById('charCount').textContent = `${count.toLocaleString()} / 3,000ì`;
    
    if (count > 3000) {
        document.getElementById('charCount').classList.add('text-red-500');
    } else {
        document.getElementById('charCount').classList.remove('text-red-500');
    }
}

// ë‚˜ê°€ê¸° í™•ì¸
function confirmExit() {
    const subject = document.getElementById('subjectInput').value;
    const content = document.getElementById('contentInput').value;
    
    if (subject || content) {
        if (confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤. ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            history.back();
        }
    } else {
        history.back();
    }
}

// í¼ ì œì¶œ ì „ ê²€ì¦
document.getElementById('writeForm').addEventListener('submit', function(e) {
    const subject = document.getElementById('subjectInput').value.trim();
    const content = document.getElementById('contentInput').value.trim();
    
    if (!subject) {
        e.preventDefault();
        alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        document.getElementById('subjectInput').focus();
        return;
    }
    
    if (!content) {
        e.preventDefault();
        alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        document.getElementById('contentInput').focus();
        return;
    }
    
    if (content.length > 3000) {
        e.preventDefault();
        alert('ë‚´ìš©ì€ 3,000ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ì œì¶œ ë²„íŠ¼ ë¹„í™œì„±í™”
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
});

// ê¸€ì ìˆ˜ ì¹´ìš´íŠ¸ ì´ë²¤íŠ¸
document.getElementById('contentInput').addEventListener('input', updateCharCount);

// ì´ˆê¸° ë¡œë“œ ì‹œ ê¸€ì ìˆ˜ í‘œì‹œ
updateCharCount();
</script>

</body>
</html>
