<?php
if (!defined('_GNUBOARD_')) exit;

// 수정 모드인지 확인
$is_edit = ($w == 'u') ? true : false;

// ✅ 세션 설정 (항상 필요!)
set_session('ss_bo_table', $bo_table);
set_session('ss_wr_id', $wr_id);

// 토큰 생성
$token = '';
if ($is_member) {
    $token = get_write_token('write');
}

// 기존 이미지 (수정 시)
$existing_images = array();
if ($is_edit) {
    $file_result = sql_query("SELECT bf_file, bf_no FROM {$g5['board_file_table']} WHERE bo_table = '{$bo_table}' AND wr_id = '{$wr_id}' AND bf_type BETWEEN 1 AND 3 ORDER BY bf_no");
    while ($file = sql_fetch_array($file_result)) {
        $existing_images[] = array(
            'file' => $file['bf_file'],
            'no' => $file['bf_no'],
            'url' => G5_DATA_URL.'/file/'.$bo_table.'/'.$file['bf_file']
        );
    }
}
?>
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title><?php echo $is_edit ? '게시글 수정' : '새 게시글'; ?></title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body { 
    font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
    margin: 0;
    padding: 0;
}
.preview-image {
    position: relative;
    width: 100%;
    padding-bottom: 100%;
    background: #f3f4f6;
    overflow: hidden;
}
.preview-image img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(0,0,0,0.7);
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
}
</style>
</head>
<body class="bg-gray-50">

<div class="max-w-2xl mx-auto bg-white min-h-screen">
    
    <!-- 헤더 -->
    <header class="fixed top-0 left-0 right-0 bg-white border-b z-50 shadow-sm" style="max-width: 640px; margin: 0 auto;">
        <div class="flex items-center justify-between px-4 py-3">
            <button type="button" onclick="confirmExit()" class="text-gray-700 px-2 py-2">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
            
            <h1 class="text-lg font-semibold text-gray-800">
                <?php echo $is_edit ? '게시글 수정' : '새 게시글'; ?>
            </h1>
            
            <button 
                type="submit" 
                form="writeForm" 
                id="submitBtn"
                class="px-5 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 active:bg-purple-800 transition-colors">
                <?php echo $is_edit ? '수정' : '등록'; ?>
            </button>
        </div>
    </header>

    <!-- 본문 -->
    <main class="pt-20 pb-24">
        <form id="writeForm" name="fwrite" method="post" enctype="multipart/form-data" action="<?php echo G5_BBS_URL; ?>/write_update.php" onsubmit="return validateForm()">
        <input type="hidden" name="w" value="<?php echo $w; ?>">
        <input type="hidden" name="bo_table" value="<?php echo $bo_table; ?>">
        <input type="hidden" name="wr_id" value="<?php echo $wr_id; ?>">
        <input type="hidden" name="sca" value="<?php echo $sca; ?>">
        <input type="hidden" name="sfl" value="<?php echo $sfl; ?>">
        <input type="hidden" name="stx" value="<?php echo $stx; ?>">
        <input type="hidden" name="spt" value="<?php echo $spt; ?>">
        <input type="hidden" name="sst" value="<?php echo $sst; ?>">
        <input type="hidden" name="sod" value="<?php echo $sod; ?>">
        <input type="hidden" name="page" value="<?php echo $page; ?>">
        
        <!-- 토큰 추가 -->
        <input type="hidden" name="token" value="<?php echo $token; ?>">
        
        <!-- 이미지 업로드 섹션 -->
        <div class="p-4 border-b">
            <label class="block mb-3">
                <span class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-image text-purple-600"></i>
                    사진 추가 (최대 5장)
                </span>
            </label>
            
            <div class="grid grid-cols-3 gap-2 mb-4" id="imagePreviewGrid">
                <label for="imageInput" class="preview-image border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-purple-400 transition-colors">
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                        <i class="fa-solid fa-plus text-3xl mb-2"></i>
                        <span class="text-xs">사진 추가</span>
                    </div>
                </label>
            </div>
            
            <input type="file" id="imageInput" name="bf_file[]" accept="image/*" multiple style="display: none;" onchange="handleImageSelect(event)">
            
            <?php if ($is_edit && count($existing_images) > 0) { ?>
            <input type="hidden" name="bf_file_del[]" id="deleteList" value="">
            <div class="text-xs text-gray-500 mb-2">기존 이미지</div>
            <div class="grid grid-cols-3 gap-2 mb-4" id="existingImages">
                <?php foreach ($existing_images as $img) { ?>
                <div class="preview-image" data-file-no="<?php echo $img['no']; ?>">
                    <img src="<?php echo $img['url']; ?>" alt="">
                    <div class="delete-btn" onclick="deleteExistingImage(<?php echo $img['no']; ?>, this)">
                        <i class="fa-solid fa-xmark text-sm"></i>
                    </div>
                </div>
                <?php } ?>
            </div>
            <?php } ?>
            
            <p class="text-xs text-gray-500 mt-2">
                <i class="fa-solid fa-info-circle mr-1"></i>
                JPG, PNG, WebP 형식 / 파일당 최대 5MB
            </p>
        </div>

        <!-- 제목 입력 -->
        <div class="p-4 border-b">
            <label class="block">
                <span class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-heading text-purple-600"></i>
                    제목
                </span>
                <input 
                    type="text" 
                    name="wr_subject" 
                    id="subjectInput"
                    value="<?php echo $is_edit ? get_text($write['wr_subject']) : ''; ?>"
                    placeholder="제목을 입력하세요"
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                    required
                    maxlength="200">
            </label>
        </div>

        <!-- 내용 입력 -->
        <div class="p-4">
            <label class="block">
                <span class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-align-left text-purple-600"></i>
                    내용
                </span>
                <textarea 
                    name="wr_content" 
                    id="contentInput"
                    placeholder="내용을 입력하세요&#10;&#10;여러분의 이야기를 나눠주세요 ✨"
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                    rows="10"
                    required><?php echo $is_edit ? get_text($write['wr_content']) : ''; ?></textarea>
            </label>
            
            <div class="flex items-center justify-between mt-3">
                <button type="button" onclick="insertEmoji()" class="text-gray-500 hover:text-purple-600 transition-colors">
                    <i class="fa-regular fa-face-smile text-xl"></i>
                </button>
                <span id="charCount" class="text-xs text-gray-500">0 / 3,000자</span>
            </div>
        </div>

        <!-- 관리자 옵션 -->
        <?php if ($is_admin) { ?>
        <div class="p-4 border-t bg-gray-50">
            <details class="group">
                <summary class="cursor-pointer text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-gear text-gray-500"></i>
                    관리자 옵션
                    <i class="fa-solid fa-chevron-down text-xs group-open:rotate-180 transition-transform ml-auto"></i>
                </summary>
                <div class="mt-3 space-y-3">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" name="notice" value="1" class="rounded">
                        <span class="text-sm text-gray-700">공지사항으로 등록</span>
                    </label>
                </div>
            </details>
        </div>
        <?php } ?>

        </form>
    </main>

</div>

<!-- 하단 고정 등록 버튼 -->
<div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 z-40" style="max-width: 640px; margin: 0 auto; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
    <button 
        type="submit" 
        form="writeForm"
        class="w-full py-4 bg-purple-600 text-white rounded-xl font-semibold text-lg hover:bg-purple-700 active:bg-purple-800 transition-colors">
        <i class="fa-solid fa-paper-plane mr-2"></i>
        <?php echo $is_edit ? '수정하기' : '등록하기'; ?>
    </button>
</div>

<script>
let selectedFiles = [];
const maxFiles = 5;

function handleImageSelect(event) {
    const files = Array.from(event.target.files);
    const grid = document.getElementById('imagePreviewGrid');
    const addButton = grid.querySelector('label[for="imageInput"]');
    
    const currentPreviews = grid.querySelectorAll('.preview-image:not(label)').length;
    
    if (currentPreviews + files.length > maxFiles) {
        alert(`최대 ${maxFiles}장까지 업로드 가능합니다.`);
        event.target.value = '';
        return;
    }
    
    for (let file of files) {
        if (file.size > 5 * 1024 * 1024) {
            alert('파일 크기는 5MB를 초과할 수 없습니다: ' + file.name);
            event.target.value = '';
            return;
        }
        
        if (!file.type.match('image.*')) {
            alert('이미지 파일만 업로드 가능합니다.');
            event.target.value = '';
            return;
        }
    }
    
    files.forEach((file) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewDiv = document.createElement('div');
            previewDiv.className = 'preview-image';
            previewDiv.innerHTML = `
                <img src="${e.target.result}" alt="">
                <div class="delete-btn" onclick="removePreview(this)">
                    <i class="fa-solid fa-xmark text-sm"></i>
                </div>
            `;
            grid.insertBefore(previewDiv, addButton);
        };
        reader.readAsDataURL(file);
    });
    
    if (currentPreviews + files.length >= maxFiles) {
        addButton.style.display = 'none';
    }
}

function removePreview(btn) {
    const preview = btn.parentElement;
    const grid = document.getElementById('imagePreviewGrid');
    const addButton = grid.querySelector('label[for="imageInput"]');
    
    preview.remove();
    addButton.style.display = 'block';
    document.getElementById('imageInput').value = '';
}

function deleteExistingImage(fileNo, btn) {
    if (!confirm('이 이미지를 삭제하시겠습니까?')) return;
    
    const preview = btn.parentElement;
    preview.remove();
    
    const deleteList = document.getElementById('deleteList');
    const currentList = deleteList.value ? deleteList.value.split(',') : [];
    currentList.push(fileNo);
    deleteList.value = currentList.join(',');
}

function insertEmoji() {
    const emojis = ['😊', '❤️', '🙏', '✨', '🎉', '👍', '💪', '🌟', '💕', '🔥'];
    const emoji = emojis[Math.floor(Math.random() * emojis.length)];
    const textarea = document.getElementById('contentInput');
    const pos = textarea.selectionStart;
    const text = textarea.value;
    textarea.value = text.slice(0, pos) + emoji + text.slice(pos);
    textarea.focus();
    textarea.setSelectionRange(pos + emoji.length, pos + emoji.length);
    updateCharCount();
}

function updateCharCount() {
    const content = document.getElementById('contentInput').value;
    const count = content.length;
    document.getElementById('charCount').textContent = `${count.toLocaleString()} / 3,000자`;
    
    if (count > 3000) {
        document.getElementById('charCount').classList.add('text-red-500');
    } else {
        document.getElementById('charCount').classList.remove('text-red-500');
    }
}

function confirmExit() {
    const subject = document.getElementById('subjectInput').value;
    const content = document.getElementById('contentInput').value;
    
    if (subject || content) {
        if (confirm('작성 중인 내용이 있습니다. 나가시겠습니까?')) {
            history.back();
        }
    } else {
        history.back();
    }
}

function validateForm() {
    const subject = document.getElementById('subjectInput').value.trim();
    const content = document.getElementById('contentInput').value.trim();
    
    if (!subject) {
        alert('제목을 입력해주세요.');
        document.getElementById('subjectInput').focus();
        return false;
    }
    
    if (!content) {
        alert('내용을 입력해주세요.');
        document.getElementById('contentInput').focus();
        return false;
    }
    
    if (content.length > 3000) {
        alert('내용은 3,000자를 초과할 수 없습니다.');
        return false;
    }
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
    
    return true;
}

document.getElementById('contentInput').addEventListener('input', updateCharCount);
updateCharCount();
</script>

</body>
</html>
